{% extends "base.html" %}

{% block title %}{% if timesheet %}Edit{% else %}New{% endif %} Time Entry - Tierney & Ohlms CRM{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{% if timesheet %}Edit Time Entry{% else %}Add Time Entry{% endif %}</h1>
    <a href="/timesheets" class="btn btn-secondary">Cancel</a>
</div>

<form method="post" action="{% if timesheet %}/timesheets/{{ timesheet.id }}/edit{% else %}/timesheets/new{% endif %}" class="form">
    <div class="form-group">
        <label for="client_id">Client *</label>
        <select id="client_id" name="client_id" required>
            <option value="">Select Client...</option>
            {% for client in clients %}
            <option value="{{ client.id }}" {% if (timesheet and timesheet.client_id == client.id) or (preselected_client_id and preselected_client_id == client.id) %}selected{% endif %}>{{ client.legal_name }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div class="form-group">
        <label for="staff_member">Staff Member *</label>
        <input type="text" id="staff_member" name="staff_member" value="{% if timesheet %}{{ timesheet.staff_member }}{% else %}{{ user.name }}{% endif %}" required>
    </div>
    
    <div class="form-group">
        <label for="entry_date">Date *</label>
        <input type="date" id="entry_date" name="entry_date" value="{% if timesheet %}{{ timesheet.entry_date.strftime('%Y-%m-%d') }}{% else %}{{ today.strftime('%Y-%m-%d') }}{% endif %}" required>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div class="form-group">
            <label for="start_time">Start Time</label>
            <input type="time" id="start_time" name="start_time" value="{% if timesheet and timesheet.start_time %}{{ timesheet.start_time }}{% endif %}" onchange="calculateHours()">
        </div>
        <div class="form-group">
            <label for="end_time">End Time</label>
            <input type="time" id="end_time" name="end_time" value="{% if timesheet and timesheet.end_time %}{{ timesheet.end_time }}{% endif %}" onchange="calculateHours()">
        </div>
    </div>
    
    <div class="form-group">
        <label for="hours">Hours *</label>
        <input type="number" id="hours" name="hours" step="0.25" min="0" value="{% if timesheet %}{{ timesheet.hours }}{% endif %}" required onchange="clearTimeFields()">
        <small style="color: #666;">Enter hours manually, or use Start/End Time to calculate automatically</small>
    </div>
    
    <div class="form-group">
        <label for="project_task">Project/Task</label>
        <input type="text" id="project_task" name="project_task" value="{% if timesheet %}{{ timesheet.project_task or '' }}{% endif %}" placeholder="e.g., Tax Return, Bookkeeping, Payroll">
    </div>
    
    <div class="form-group">
        <label for="description">Description</label>
        <textarea id="description" name="description" rows="4" placeholder="What work was performed?">{% if timesheet %}{{ timesheet.description or '' }}{% endif %}</textarea>
    </div>
    
    <div class="form-group">
        <label style="display: flex; align-items: center; gap: 0.5rem;">
            <input type="checkbox" id="billable" name="billable" {% if not timesheet or timesheet.billable %}checked{% endif %}>
            <span>Billable</span>
        </label>
    </div>
    
    <div class="form-actions">
        <button type="submit" class="btn btn-primary">{% if timesheet %}Update{% else %}Create{% endif %} Entry</button>
        <a href="/timesheets" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
function calculateHours() {
    const startTime = document.getElementById('start_time').value;
    const endTime = document.getElementById('end_time').value;
    
    if (startTime && endTime) {
        const start = new Date(`2000-01-01T${startTime}`);
        let end = new Date(`2000-01-01T${endTime}`);
        
        if (end < start) {
            end.setDate(end.getDate() + 1); // Handle overnight
        }
        
        const hours = (end - start) / (1000 * 60 * 60);
        document.getElementById('hours').value = hours.toFixed(2);
    }
}

function clearTimeFields() {
    // Optional: clear time fields when hours are manually entered
    // For now, we'll keep both options available
}
</script>
{% endblock %}

