{% extends "base.html" %}

{% block title %}Timesheets - Tierney & Ohlms CRM{% endblock %}

{% block content %}
<div class="page-header">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <h1>Timesheets</h1>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button onclick="openTimesheetModal()" class="btn btn-primary">+ Add Time Entry</button>
        </div>
    </div>
</div>

<!-- Quick Timer Setup (shown when timer not running) -->
<div id="timer-setup" style="background: #f8f8f8; padding: 1.5rem; margin-bottom: 1.5rem; border: 2px solid #000;">
    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Select Client for Timer:</label>
            <select id="timer-client" style="width: 100%; padding: 0.75rem; border: 2px solid #000; font-size: 1rem;">
                <option value="">Choose a client...</option>
                {% for client in clients %}
                <option value="{{ client.id }}">{{ client.legal_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Project/Task (optional):</label>
            <input type="text" id="timer-project" placeholder="e.g., Tax Return, Bookkeeping" style="width: 100%; padding: 0.75rem; border: 2px solid #000;">
        </div>
        <div style="display: flex; align-items: end; gap: 0.5rem;">
            <button id="timer-btn" onclick="startTimer()" class="btn btn-primary" style="padding: 0.75rem 1.5rem; font-size: 1rem;">Start Timer</button>
        </div>
    </div>
</div>

<!-- Timer Display (shown when timer is running) -->
<div id="timer-container" style="display: none; background: #000; color: #fff; padding: 2rem; margin-bottom: 1.5rem; border: 3px solid #fff; text-align: center;">
    <div style="font-size: 3.5rem; font-family: 'Courier New', monospace; margin-bottom: 1.5rem; font-weight: bold;" id="timer-display">00:00:00</div>
    <div style="margin-bottom: 1.5rem; font-size: 1.2rem;">
        <strong id="timer-client-name" style="color: #fff;"></strong>
        <span id="timer-project-name" style="color: #ccc; margin-left: 1rem;"></span>
    </div>
    <div style="margin-bottom: 1.5rem;">
        <textarea id="timer-description" placeholder="What are you working on? (optional)" style="padding: 0.75rem; width: 100%; max-width: 500px; min-height: 80px; border: 2px solid #fff; background: #1a1a1a; color: #fff; font-family: Georgia, 'Times New Roman', Times, serif;"></textarea>
    </div>
    <div>
        <button onclick="stopTimer()" class="btn" style="background: #dc2626; color: white; border: 2px solid white; padding: 1rem 2rem; font-size: 1.1rem; font-weight: bold; margin-right: 1rem;">Stop & Save</button>
        <button onclick="cancelTimer()" class="btn" style="background: #666; color: white; border: 2px solid white; padding: 1rem 2rem; font-size: 1.1rem;">Cancel</button>
    </div>
</div>

<!-- Summary Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
    <div class="detail-section" style="text-align: center;">
        <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">This Week</div>
        <div style="font-size: 2rem; font-weight: bold; font-family: Georgia, 'Times New Roman', Times, serif;">{{ "{:.1f}".format(summary_week.total_hours) }}h</div>
        <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">{{ "{:.1f}".format(summary_week.billable_hours) }}h billable</div>
    </div>
    <div class="detail-section" style="text-align: center;">
        <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">This Month</div>
        <div style="font-size: 2rem; font-weight: bold; font-family: Georgia, 'Times New Roman', Times, serif;">{{ "{:.1f}".format(summary_month.total_hours) }}h</div>
        <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">{{ "{:.1f}".format(summary_month.billable_hours) }}h billable</div>
    </div>
    <div class="detail-section" style="text-align: center;">
        <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">Filtered Total</div>
        <div style="font-size: 2rem; font-weight: bold; font-family: Georgia, 'Times New Roman', Times, serif;">{{ "{:.1f}".format(summary_all.total_hours) }}h</div>
        <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">{{ "{:.1f}".format(summary_all.billable_hours) }}h billable</div>
    </div>
</div>

<!-- Filters -->
<div class="detail-section" style="margin-bottom: 1.5rem;">
    <form method="get" action="/timesheets" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
        <div class="form-group" style="margin: 0;">
            <label for="client_id">Client</label>
            <select id="client_id" name="client_id" onchange="this.form.submit()">
                <option value="">All Clients</option>
                {% for client in clients %}
                <option value="{{ client.id }}" {% if selected_client_id == client.id %}selected{% endif %}>{{ client.legal_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group" style="margin: 0;">
            <label for="date_from">From Date</label>
            <input type="date" id="date_from" name="date_from" value="{{ date_from or '' }}" onchange="this.form.submit()">
        </div>
        <div class="form-group" style="margin: 0;">
            <label for="date_to">To Date</label>
            <input type="date" id="date_to" name="date_to" value="{{ date_to or '' }}" onchange="this.form.submit()">
        </div>
        <div class="form-group" style="margin: 0;">
            <label for="search">Search</label>
            <input type="text" id="search" name="search" value="{{ search or '' }}" placeholder="Description, project, staff...">
        </div>
        <div>
            <button type="submit" class="btn btn-primary">Filter</button>
            <a href="/timesheets" class="btn btn-secondary">Clear</a>
        </div>
    </form>
</div>

<!-- Timesheets Table -->
<div class="detail-section">
    {% if timesheets %}
    <div style="overflow-x: auto;">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Client</th>
                    <th>Staff</th>
                    <th>Project/Task</th>
                    <th>Hours</th>
                    <th>Time</th>
                    <th>Description</th>
                    <th>Billable</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in timesheets %}
                <tr>
                    <td>{{ entry.entry_date.strftime('%b %d, %Y') }}</td>
                    <td><a href="/clients/{{ entry.client_id }}" class="link-primary">{{ entry.client.legal_name }}</a></td>
                    <td>{{ entry.staff_member }}</td>
                    <td>{{ entry.project_task or '-' }}</td>
                    <td style="font-family: 'Courier New', monospace; font-weight: bold;">{{ "{:.2f}".format(entry.hours) }}h</td>
                    <td>
                        {% if entry.start_time and entry.end_time %}
                            {{ entry.start_time }} - {{ entry.end_time }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ entry.description or '' }}">
                        {{ entry.description[:50] if entry.description else '-' }}{% if entry.description and entry.description|length > 50 %}...{% endif %}
                    </td>
                    <td>
                        {% if entry.billable %}
                            <span style="color: #16a34a; font-weight: bold;">Yes</span>
                        {% else %}
                            <span style="color: #666;">No</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="/timesheets/{{ entry.id }}/edit" class="btn btn-sm btn-secondary">Edit</a>
                        <form method="post" action="/timesheets/{{ entry.id }}/delete" style="display: inline;" onsubmit="return confirm('Delete this time entry?');">
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 3rem; color: #666;">
        <p>No timesheet entries found.</p>
        <a href="/timesheets/new" class="btn btn-primary">Add Your First Entry</a>
    </div>
    {% endif %}
</div>

<!-- Add/Edit Modal -->
<div id="timesheet-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
    <div style="max-width: 600px; margin: 2rem auto; background: white; padding: 2rem; border: 2px solid #000;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 id="modal-title">Add Time Entry</h2>
            <button onclick="closeTimesheetModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>
        
        <form id="timesheet-form" method="post" action="">
            <input type="hidden" id="form-timesheet-id" name="timesheet_id" value="">
            
            <div class="form-group">
                <label for="form-client-id">Client *</label>
                <select id="form-client-id" name="client_id" required>
                    <option value="">Select Client...</option>
                    {% for client in clients %}
                    <option value="{{ client.id }}">{{ client.legal_name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="form-staff-member">Staff Member *</label>
                <input type="text" id="form-staff-member" name="staff_member" value="{{ user.name }}" required>
            </div>
            
            <div class="form-group">
                <label for="form-entry-date">Date *</label>
                <input type="date" id="form-entry-date" name="entry_date" value="{{ today.strftime('%Y-%m-%d') }}" required>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label for="form-start-time">Start Time</label>
                    <input type="time" id="form-start-time" name="start_time" onchange="calculateHours()">
                </div>
                <div class="form-group">
                    <label for="form-end-time">End Time</label>
                    <input type="time" id="form-end-time" name="end_time" onchange="calculateHours()">
                </div>
            </div>
            
            <div class="form-group">
                <label for="form-hours">Hours *</label>
                <input type="number" id="form-hours" name="hours" step="0.25" min="0" required onchange="clearTimeFields()">
                <small style="color: #666;">Enter hours manually, or use Start/End Time to calculate</small>
            </div>
            
            <div class="form-group">
                <label for="form-project-task">Project/Task</label>
                <input type="text" id="form-project-task" name="project_task" placeholder="e.g., Tax Return, Bookkeeping">
            </div>
            
            <div class="form-group">
                <label for="form-description">Description</label>
                <textarea id="form-description" name="description" rows="4" placeholder="What work was performed?"></textarea>
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="form-billable" name="billable" checked>
                    <span>Billable</span>
                </label>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Save</button>
                <button type="button" onclick="closeTimesheetModal()" class="btn btn-secondary">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
let timerInterval = null;
let timerStartTime = null;
let timerRunning = false;

// Round up to nearest 15-minute increment (0.25 hours)
function roundUpToQuarterHour(hours) {
    // Convert to minutes, round up to nearest 15, convert back to hours
    const minutes = hours * 60;
    const roundedMinutes = Math.ceil(minutes / 15) * 15;
    return roundedMinutes / 60;
}

// Timer Functions
function startTimer() {
    const setup = document.getElementById('timer-setup');
    const container = document.getElementById('timer-container');
    const clientSelect = document.getElementById('timer-client');
    const projectInput = document.getElementById('timer-project');
    
    // Validate client selection
    if (!clientSelect.value) {
        alert('Please select a client first');
        clientSelect.focus();
        clientSelect.style.borderColor = '#dc2626';
        return;
    }
    
    // Get selected client name
    const clientName = clientSelect.options[clientSelect.selectedIndex].text;
    const projectName = projectInput.value;
    
    // Hide setup, show timer
    setup.style.display = 'none';
    container.style.display = 'block';
    
    // Display client and project info
    document.getElementById('timer-client-name').textContent = clientName;
    if (projectName) {
        document.getElementById('timer-project-name').textContent = 'â€¢ ' + projectName;
    } else {
        document.getElementById('timer-project-name').textContent = '';
    }
    
    // Start timer
    timerStartTime = new Date();
    timerRunning = true;
    timerInterval = setInterval(updateTimerDisplay, 1000);
    updateTimerDisplay();
}

function stopTimer() {
    if (!timerRunning) return;
    
    clearInterval(timerInterval);
    timerRunning = false;
    
    const clientId = document.getElementById('timer-client').value;
    const project = document.getElementById('timer-project').value;
    const description = document.getElementById('timer-description').value;
    const endTime = new Date();
    const rawHours = (endTime - timerStartTime) / (1000 * 60 * 60);
    
    // Round up to nearest 15-minute increment
    const roundedHours = roundUpToQuarterHour(rawHours);
    
    // Show setup again, hide timer
    document.getElementById('timer-setup').style.display = 'block';
    document.getElementById('timer-container').style.display = 'none';
    document.getElementById('timer-display').textContent = '00:00:00';
    
    // Clear description but keep client/project for next time
    document.getElementById('timer-description').value = '';
    
    // Open modal first, then populate values (use setTimeout to ensure modal is visible)
    openTimesheetModalFromTimer();
    
    // Set values after a tiny delay to ensure form fields are accessible
    setTimeout(function() {
        document.getElementById('form-client-id').value = clientId;
        document.getElementById('form-project-task').value = project;
        document.getElementById('form-description').value = description;
        document.getElementById('form-hours').value = roundedHours.toFixed(2);
        document.getElementById('form-entry-date').value = timerStartTime.toISOString().split('T')[0];
        document.getElementById('form-start-time').value = timerStartTime.toTimeString().slice(0, 5);
        document.getElementById('form-end-time').value = endTime.toTimeString().slice(0, 5);
        document.getElementById('form-staff-member').value = '{{ user.name }}';
        document.getElementById('form-billable').checked = true;
    }, 10);
}

function cancelTimer() {
    clearInterval(timerInterval);
    timerRunning = false;
    
    // Show setup, hide timer
    document.getElementById('timer-setup').style.display = 'block';
    document.getElementById('timer-container').style.display = 'none';
    document.getElementById('timer-display').textContent = '00:00:00';
    
    // Clear description but keep client/project selection
    document.getElementById('timer-description').value = '';
    
    timerStartTime = null;
}

function updateTimerDisplay() {
    if (!timerStartTime) return;
    
    const now = new Date();
    const elapsed = Math.floor((now - timerStartTime) / 1000);
    const hours = Math.floor(elapsed / 3600);
    const minutes = Math.floor((elapsed % 3600) / 60);
    const seconds = elapsed % 60;
    
    const display = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    document.getElementById('timer-display').textContent = display;
}

// Modal Functions
function openTimesheetModal(timesheetId = null) {
    const modal = document.getElementById('timesheet-modal');
    const form = document.getElementById('timesheet-form');
    const title = document.getElementById('modal-title');
    
    if (timesheetId) {
        title.textContent = 'Edit Time Entry';
        form.action = `/timesheets/${timesheetId}/edit`;
        // Load timesheet data (would need API call or pre-filled from server)
    } else {
        title.textContent = 'Add Time Entry';
        form.action = '/timesheets/new';
        form.reset();
        document.getElementById('form-staff-member').value = '{{ user.name }}';
        document.getElementById('form-entry-date').value = '{{ today.strftime("%Y-%m-%d") }}';
        document.getElementById('form-billable').checked = true;
    }
    
    modal.style.display = 'block';
}

// Open modal from timer (don't reset form - values will be set after)
function openTimesheetModalFromTimer() {
    const modal = document.getElementById('timesheet-modal');
    const form = document.getElementById('timesheet-form');
    const title = document.getElementById('modal-title');
    
    title.textContent = 'Add Time Entry';
    form.action = '/timesheets/new';
    // Don't reset - values will be set by stopTimer() after modal opens
    
    modal.style.display = 'block';
}

function closeTimesheetModal() {
    document.getElementById('timesheet-modal').style.display = 'none';
}

// Close modal when clicking outside
document.getElementById('timesheet-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeTimesheetModal();
    }
});

// Calculate hours from start/end time
function calculateHours() {
    const startTime = document.getElementById('form-start-time').value;
    const endTime = document.getElementById('form-end-time').value;
    
    if (startTime && endTime) {
        const start = new Date(`2000-01-01T${startTime}`);
        let end = new Date(`2000-01-01T${endTime}`);
        
        if (end < start) {
            end.setDate(end.getDate() + 1); // Handle overnight
        }
        
        const rawHours = (end - start) / (1000 * 60 * 60);
        // Round up to nearest 15-minute increment
        const roundedHours = roundUpToQuarterHour(rawHours);
        document.getElementById('form-hours').value = roundedHours.toFixed(2);
    }
}

function clearTimeFields() {
    // Optional: clear time fields when hours are manually entered
}

// Make edit links open modal (for now, they'll go to edit page - can enhance later)
</script>
{% endblock %}

